<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - EchoWrites</title>
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .dashboard-container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-card h3 {
            margin: 0;
            color: #666;
        }

        .stat-card .number {
            font-size: 24px;
            font-weight: bold;
            color: #2196F3;
            margin: 10px 0;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            background: #f5f5f5;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .tab.active {
            background: #2196F3;
            color: white;
        }

        .table-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #f5f5f5;
            font-weight: 600;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
        }

        .edit-btn {
            background: #4CAF50;
            color: white;
        }

        .delete-btn {
            background: #f44336;
            color: white;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            background: #4CAF50;
            color: white;
        }

        .status-badge.pending {
            background: #ff9800;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 800px;
            margin: 50px auto;
            position: relative;
        }

        .close {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 24px;
            cursor: pointer;
        }

        .blog-content {
            margin: 15px 0;
            white-space: pre-wrap;
        }

        .comment-section, .likes-section {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .user-info {
            color: #666;
            font-size: 0.9em;
            margin: 5px 0;
        }
        
        .chart-container {
            margin-top: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .chart {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .chart-title {
            margin-top: 0;
            color: #333;
            text-align: center;
            margin-bottom: 15px;
        }
        
        .analytics-metric {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .analytics-metric h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #333;
        }
        
        .analytics-value {
            font-size: 18px;
            font-weight: bold;
            color: #2196F3;
        }
        
        /* User Management Styles */
        .detail-value {
            padding: 8px 12px;
            background: #f5f5f5;
            border-radius: 4px;
            margin-top: 5px;
        }
        
        .user-activity-tab {
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }
        
        .activity-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        .activity-table th, .activity-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .activity-table th {
            background: #f5f5f5;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- Header Section -->
    <header>
        <!-- Top Row -->
        <div class="top-bar">
            <div class="logo">
                <a href="/"><i class="fas fa-blog"></i> EchoWrites</a>
            </div>
            <div class="welcome-message" id="welcome-message" style="display: none;">
                Welcome Admin! <span id="header-username"></span>
            </div>
        </div>
        
        <!-- Bottom Row -->
        <div class="nav-bar">
            <div class="nav-left">
                <nav>
                    <a href="/">Home</a>
                    <a href="admin.html" class="active">Admin Dashboard</a>
                </nav>
            </div>
            
            <div class="nav-right">
                <a href="#" id="logout-btn" onclick="logout()">Logout</a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="dashboard-container">
        <h1>Admin Dashboard</h1>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Posts</h3>
                <div class="number" id="total-posts">0</div>
            </div>
            <div class="stat-card">
                <h3>Total Comments</h3>
                <div class="number" id="total-comments">0</div>
            </div>
            <div class="stat-card">
                <h3>Total Users</h3>
                <div class="number" id="total-users">0</div>
            </div>
            <div class="stat-card">
                <h3>Posts Today</h3>
                <div class="number" id="posts-today">0</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab" onclick="showTab('posts')">Posts</button>
            <button class="tab" onclick="showTab('comments')">Comments</button>
            <button class="tab" onclick="showTab('likes')">Likes</button>
            <button class="tab" onclick="showTab('shares')">Shares</button>
            <button class="tab" onclick="showTab('users')">Users</button>
            <button class="tab" onclick="showTab('analytics')">Analytics</button>
        </div>

        <div id="posts-tab" class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Author</th>
                        <th>Category</th>
                        <th>Comments</th>
                        <th>Likes</th>
                        <th>Shares</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="posts-table-body"></tbody>
            </table>
        </div>

        <div id="comments-tab" class="table-container" style="display: none;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                <h2>Comments</h2>
                <button class="action-btn edit-btn" onclick="loadComments()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Author</th>
                        <th>Comment</th>
                        <th>Post</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="comments-table-body"></tbody>
            </table>
        </div>

        <div id="likes-tab" class="table-container" style="display: none;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                <h2>Likes</h2>
                <button class="action-btn edit-btn" onclick="loadLikes()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Post</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="likes-table-body"></tbody>
            </table>
        </div>

        <div id="shares-tab" class="table-container" style="display: none;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                <h2>Shares</h2>
                <button class="action-btn edit-btn" onclick="loadShares()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Post Title</th>
                        <th>Author</th>
                        <th>Share Count</th>
                        <th>Last Shared</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="shares-table-body"></tbody>
            </table>
        </div>

        <div id="users-tab" class="table-container" style="display: none;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                <h2>User Management</h2>
                <button class="action-btn edit-btn" onclick="loadUsers()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Full Name</th>
                        <th>Status</th>
                        <th>Subscription</th>
                        <th>Registration Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="users-table-body"></tbody>
            </table>
        </div>

        <div id="analytics-tab" class="table-container" style="display: none;">
            <h2>Blog Analytics</h2>
            
            <div class="analytics-metric">
                <h4>Overall Statistics</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    <div>
                        <div>Total Posts</div>
                        <div class="analytics-value" id="analytics-total-posts">0</div>
                    </div>
                    <div>
                        <div>Total Comments</div>
                        <div class="analytics-value" id="analytics-total-comments">0</div>
                    </div>
                    <div>
                        <div>Total Users</div>
                        <div class="analytics-value" id="analytics-total-users">0</div>
                    </div>
                    <div>
                        <div>Average Posts Per Day</div>
                        <div class="analytics-value" id="analytics-avg-posts">0</div>
                    </div>
                </div>
            </div>
            
            <div class="analytics-metric">
                <h4>Engagement Analytics</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    <div>
                        <div>Comments Per Post</div>
                        <div class="analytics-value" id="analytics-comments-per-post">0</div>
                    </div>
                    <div>
                        <div>Likes Per Post</div>
                        <div class="analytics-value" id="analytics-likes-per-post">0</div>
                    </div>
                    <div>
                        <div>Shares Per Post</div>
                        <div class="analytics-value" id="analytics-shares-per-post">0</div>
                    </div>
                    <div>
                        <div>Active Users</div>
                        <div class="analytics-value" id="analytics-active-users">0</div>
                    </div>
                </div>
            </div>
            
            <div class="analytics-metric">
                <h4>Top Content</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    <div>
                        <div>Top Category</div>
                        <div class="analytics-value" id="analytics-top-category">None</div>
                    </div>
                    <div>
                        <div>Most Commented Post</div>
                        <div class="analytics-value" id="analytics-most-commented">None</div>
                    </div>
                    <div>
                        <div>Most Liked Post</div>
                        <div class="analytics-value" id="analytics-most-liked">None</div>
                    </div>
                    <div>
                        <div>Most Shared Post</div>
                        <div class="analytics-value" id="analytics-most-shared">None</div>
                    </div>
                </div>
            </div>
            
            <div class="chart-container">
                <div class="chart">
                    <h3 class="chart-title">Posts Over Time</h3>
                    <div id="posts-trend-chart" style="height: 300px;"></div>
                </div>
                <div class="chart">
                    <h3 class="chart-title">Activity By Day of Week</h3>
                    <div id="day-of-week-chart" style="height: 300px;"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Edit Blog Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Edit Blog Post</h2>
            <form id="editBlogForm">
                <input type="hidden" id="editBlogId">
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="editTitle" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <input type="text" id="editCategory" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Content</label>
                    <textarea id="editContent" class="form-control" rows="10" required></textarea>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="editStatus" class="form-control">
                        <option value="published">Published</option>
                        <option value="draft">Draft</option>
                        <option value="archived">Archived</option>
                    </select>
                </div>
                <div class="form-group" style="margin-top: 20px;">
                    <button type="button" class="action-btn edit-btn" onclick="saveEditedBlog()">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- User Detail Modal -->
    <div id="userDetailModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeUserModal()">&times;</span>
            <h2>User Details</h2>
            <div id="userDetailContent">
                <div class="form-group">
                    <label>Username</label>
                    <div id="userDetailUsername" class="detail-value"></div>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <div id="userDetailEmail" class="detail-value"></div>
                </div>
                <div class="form-group">
                    <label>Full Name</label>
                    <div id="userDetailFullname" class="detail-value"></div>
                </div>
                <div class="form-group">
                    <label>Bio</label>
                    <div id="userDetailBio" class="detail-value"></div>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="userDetailStatus" class="form-control">
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="suspended">Suspended</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Subscription Status</label>
                    <div id="userDetailSubscription" class="detail-value"></div>
                </div>
                <div class="form-group">
                    <label>Registration Date</label>
                    <div id="userDetailRegistration" class="detail-value"></div>
                </div>
                
                <h3>User Activity</h3>
                <div class="tabs" style="margin-top: 15px;">
                    <button class="tab active" onclick="showUserActivityTab('posts')">Posts</button>
                    <button class="tab" onclick="showUserActivityTab('comments')">Comments</button>
                </div>
                
                <div id="userPostsTab" class="user-activity-tab">
                    <table class="activity-table">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Category</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="userPostsTableBody"></tbody>
                    </table>
                </div>
                
                <div id="userCommentsTab" class="user-activity-tab" style="display: none;">
                    <table class="activity-table">
                        <thead>
                            <tr>
                                <th>Post</th>
                                <th>Comment</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="userCommentsTableBody"></tbody>
                    </table>
                </div>
                
                <div class="form-group" style="margin-top: 20px;">
                    <button type="button" class="action-btn edit-btn" onclick="saveUserDetails()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Check admin authentication
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login.html';
        }

        document.addEventListener('DOMContentLoaded', async function() {
            // Show welcome message
            document.getElementById('welcome-message').style.display = 'block';
            document.getElementById('header-username').textContent = localStorage.getItem('username');

            // Load initial data
            await loadStats();
            showTab('posts');

            // Modal close button
            document.querySelector('.close').onclick = function() {
                document.getElementById('editModal').style.display = 'none';
            }

            // Close modal when clicking outside
            window.onclick = function(event) {
                if (event.target == document.getElementById('editModal')) {
                    document.getElementById('editModal').style.display = 'none';
                }
            }
        });

        async function loadStats() {
            try {
                const response = await fetch('/api/admin/stats', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const stats = await response.json();
                
                document.getElementById('total-posts').textContent = stats.totalPosts;
                document.getElementById('total-comments').textContent = stats.totalComments;
                document.getElementById('total-users').textContent = stats.totalUsers;
                document.getElementById('posts-today').textContent = stats.postsToday;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        function showTab(tab) {
            // Update tab styling
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab[onclick="showTab('${tab}')"]`).classList.add('active');
            
            // Hide all tabs
            document.getElementById('posts-tab').style.display = 'none';
            document.getElementById('comments-tab').style.display = 'none';
            document.getElementById('likes-tab').style.display = 'none';
            document.getElementById('shares-tab').style.display = 'none';
            document.getElementById('users-tab').style.display = 'none';
            document.getElementById('analytics-tab').style.display = 'none';
            
            // Show selected tab
            document.getElementById(`${tab}-tab`).style.display = 'block';
            
            // Load data
            if (tab === 'posts') loadPosts();
            else if (tab === 'comments') loadComments();
            else if (tab === 'likes') loadLikes();
            else if (tab === 'shares') loadShares();
            else if (tab === 'users') loadUsers();
            else if (tab === 'analytics') loadAnalytics();
        }

        async function loadPosts() {
            try {
                const response = await fetch('/api/admin/posts', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const posts = await response.json();
                console.log('Posts data received:', posts);
                console.log('First post shareCount:', posts[0]?.shareCount);
                
                const tableBody = document.getElementById('posts-table-body');
                tableBody.innerHTML = posts.map(post => {
                    console.log('Processing post:', post.title, 'shareCount:', post.shareCount);
                    return `
                    <tr>
                        <td>${post.title}</td>
                        <td>${post.author ? post.author.username : 'Unknown'}</td>
                        <td>${post.category || 'Uncategorized'}</td>
                        <td>${post.comments.length}</td>
                        <td>${post.likes.length}</td>
                        <td>${typeof post.shareCount !== 'undefined' ? post.shareCount : 0}</td>
                        <td>${new Date(post.createdAt).toLocaleDateString()}</td>
                        <td>
                            <button class="action-btn edit-btn" onclick="editBlog('${post._id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete-btn" onclick="deleteBlog('${post._id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading posts:', error);
            }
        }

        async function loadComments() {
            try {
                const response = await fetch('/api/admin/comments', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const comments = await response.json();
                console.log('Comments data received:', comments);
                
                const tableBody = document.getElementById('comments-table-body');
                if (comments.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="6" style="text-align: center;">No comments found</td></tr>`;
                    return;
                }

                // Add a debug message showing expected vs. actual comment count
                const statsResponse = await fetch('/api/admin/stats', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const stats = await statsResponse.json();
                const totalComments = stats.totalComments;
                
                if (comments.length < totalComments) {
                    console.warn(`Warning: Expected ${totalComments} comments, but only received ${comments.length}`);
                    // Add a debug message at the top of the table
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; color: #ff9900; background-color: #fff3cd; padding: 10px;">
                                <strong>Note:</strong> Some comments may not be displayed correctly. 
                                System shows ${totalComments} total comments, but only ${comments.length} could be retrieved.
                                This is being addressed.
                            </td>
                        </tr>
                    `;
                } else {
                    tableBody.innerHTML = '';
                }
                
                // Append each comment row
                const commentRows = comments.map(comment => `
                    <tr>
                        <td>${comment.author?.username || 'Unknown User'}</td>
                        <td>${comment.content || 'No content'}</td>
                        <td>${comment.postTitle || 'Unknown Post'}</td>
                        <td>${new Date(comment.createdAt || Date.now()).toLocaleDateString()}</td>
                        <td>
                            <span class="status-badge ${comment.status !== 'Approved' ? 'pending' : ''}">
                                ${comment.status || 'Pending'}
                            </span>
                        </td>
                        <td>
                            ${comment.status !== 'Approved' ? 
                                `<button class="action-btn edit-btn" onclick="approveComment('${comment._id}')">
                                    <i class="fas fa-check"></i>
                                </button>` : ''
                            }
                            <button class="action-btn delete-btn" onclick="deleteComment('${comment._id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
                
                tableBody.innerHTML += commentRows;
            } catch (error) {
                console.error('Error loading comments:', error);
                document.getElementById('comments-table-body').innerHTML = 
                    `<tr><td colspan="6" style="text-align: center;">Error loading comments: ${error.message}</td></tr>`;
            }
        }

        async function loadLikes() {
            try {
                const response = await fetch('/api/admin/likes', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const likes = await response.json();
                console.log('Likes data received:', likes);
                
                const tableBody = document.getElementById('likes-table-body');
                if (likes.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="4" style="text-align: center;">No likes found</td></tr>`;
                    return;
                }
                
                // Get current stats to check for discrepancies
                const postsResponse = await fetch('/api/admin/posts', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const posts = await postsResponse.json();
                const totalLikes = posts.reduce((sum, post) => sum + (post.likes?.length || 0), 0);
                
                if (likes.length < totalLikes) {
                    console.warn(`Warning: Expected ${totalLikes} likes, but only received ${likes.length}`);
                    // Add a debug message at the top of the table
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="4" style="text-align: center; color: #ff9900; background-color: #fff3cd; padding: 10px;">
                                <strong>Note:</strong> Some likes may not be displayed correctly. 
                                System shows ${totalLikes} total likes, but only ${likes.length} could be retrieved.
                                This is being addressed.
                            </td>
                        </tr>
                    `;
                } else {
                    tableBody.innerHTML = '';
                }
                
                // Append each like row
                const likeRows = likes.map(like => `
                    <tr>
                        <td>${like.user?.username || 'Unknown User'}</td>
                        <td>${like.postTitle || 'Unknown Post'}</td>
                        <td>${new Date(like.createdAt || Date.now()).toLocaleDateString()}</td>
                        <td>
                            <button class="action-btn delete-btn" onclick="deleteLike('${like._id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
                
                tableBody.innerHTML += likeRows;
            } catch (error) {
                console.error('Error loading likes:', error);
                document.getElementById('likes-table-body').innerHTML = 
                    `<tr><td colspan="4" style="text-align: center;">Error loading likes: ${error.message}</td></tr>`;
            }
        }

        async function loadShares() {
            try {
                const response = await fetch('/api/admin/shares', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    throw new Error(`Server responded with status: ${response.status}`);
                }
                
                const responseText = await response.text();
                console.log('Raw response from shares endpoint:', responseText);
                
                let sharedPosts = [];
                try {
                    sharedPosts = JSON.parse(responseText);
                    console.log('Shared posts from dedicated endpoint:', sharedPosts);
                } catch (parseError) {
                    console.error('Error parsing JSON response:', parseError);
                    throw new Error(`Failed to parse JSON: ${parseError.message}`);
                }
                
                // No need to filter as the endpoint already returns only shared posts
                console.log('Filtered shared posts:', sharedPosts);
                
                const tableBody = document.getElementById('shares-table-body');
                if (!Array.isArray(sharedPosts) || sharedPosts.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="5" style="text-align: center;">No shared posts found</td></tr>`;
                    return;
                }
                
                tableBody.innerHTML = sharedPosts.map(post => {
                    console.log('Rendering shared post:', post.title, 'with shareCount:', post.shareCount);
                    return `
                    <tr>
                        <td>${post.title}</td>
                        <td>${post.author ? post.author.username : 'Unknown'}</td>
                        <td>${post.shareCount}</td>
                        <td>${new Date(post.updatedAt).toLocaleDateString()}</td>
                        <td>
                            <button class="action-btn edit-btn" onclick="viewPost('${post._id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading shares:', error);
                document.getElementById('shares-table-body').innerHTML = 
                    `<tr><td colspan="5" style="text-align: center;">Error loading shares: ${error.message}</td></tr>`;
            }
        }

        async function loadAnalytics() {
            try {
                const response = await fetch('/api/admin/analytics', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const analytics = await response.json();
                
                // Update analytics values
                document.getElementById('analytics-total-posts').textContent = analytics.totalPosts;
                document.getElementById('analytics-total-comments').textContent = analytics.totalComments;
                document.getElementById('analytics-total-users').textContent = analytics.totalUsers;
                document.getElementById('analytics-avg-posts').textContent = analytics.avgPostsPerDay;
                document.getElementById('analytics-comments-per-post').textContent = analytics.avgCommentsPerPost || "0";
                
                // Calculate additional metrics
                const postsResponse = await fetch('/api/admin/posts', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const posts = await postsResponse.json();
                
                // Likes per post
                const totalLikes = posts.reduce((sum, post) => sum + post.likes.length, 0);
                const likesPerPost = posts.length > 0 ? (totalLikes / posts.length).toFixed(2) : "0";
                document.getElementById('analytics-likes-per-post').textContent = likesPerPost;
                
                // Fetch share data from dedicated endpoint
                try {
                    const sharesResponse = await fetch('/api/admin/shares', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (!sharesResponse.ok) {
                        console.error(`Error fetching shares data: ${sharesResponse.status}`);
                        document.getElementById('analytics-shares-per-post').textContent = '0';
                    } else {
                        const responseText = await sharesResponse.text();
                        let sharedPosts = [];
                        
                        try {
                            sharedPosts = JSON.parse(responseText);
                            console.log('Share data for analytics:', sharedPosts);
                            
                            // Calculate shares per post
                            const totalShares = Array.isArray(sharedPosts) ? 
                                sharedPosts.reduce((sum, post) => sum + (post.shareCount || 0), 0) : 0;
                            console.log('Total shares calculated:', totalShares);
                            const sharesPerPost = posts.length > 0 ? (totalShares / posts.length).toFixed(2) : "0";
                            console.log('Shares per post calculated:', sharesPerPost);
                            document.getElementById('analytics-shares-per-post').textContent = sharesPerPost;
                        } catch (parseError) {
                            console.error('Error parsing shares JSON:', parseError);
                            document.getElementById('analytics-shares-per-post').textContent = '0';
                        }
                    }
                } catch (error) {
                    console.error('Error in shares analytics:', error);
                    document.getElementById('analytics-shares-per-post').textContent = '0';
                }
                
                // Top category
                const categories = {};
                posts.forEach(post => {
                    const category = post.category || 'Uncategorized';
                    categories[category] = (categories[category] || 0) + 1;
                });
                
                let topCategory = 'None';
                let maxCount = 0;
                
                for (const [category, count] of Object.entries(categories)) {
                    if (count > maxCount) {
                        maxCount = count;
                        topCategory = category;
                    }
                }
                
                document.getElementById('analytics-top-category').textContent = topCategory;
                
                // Most commented post
                let mostCommentedPost = null;
                let mostComments = 0;
                
                posts.forEach(post => {
                    if (post.comments.length > mostComments) {
                        mostComments = post.comments.length;
                        mostCommentedPost = post;
                    }
                });
                
                document.getElementById('analytics-most-commented').textContent = 
                    mostCommentedPost ? `${mostCommentedPost.title} (${mostComments})` : 'None';
                
                // Most liked post
                let mostLikedPost = null;
                let mostLikes = 0;
                
                posts.forEach(post => {
                    if (post.likes.length > mostLikes) {
                        mostLikes = post.likes.length;
                        mostLikedPost = post;
                    }
                });
                
                document.getElementById('analytics-most-liked').textContent = 
                    mostLikedPost ? `${mostLikedPost.title} (${mostLikes})` : 'None';
                
                // Most shared post - handle this in a separate try-catch block
                try {
                    // Fetch share data specifically for most shared post
                    const mostSharedResponse = await fetch('/api/admin/shares', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (mostSharedResponse.ok) {
                        const responseText = await mostSharedResponse.text();
                        let mostSharedPosts = [];
                        
                        try {
                            mostSharedPosts = JSON.parse(responseText);
                            
                            if (Array.isArray(mostSharedPosts) && mostSharedPosts.length > 0) {
                                // The sharedPosts array is already sorted by shareCount (highest first)
                                const mostSharedPost = mostSharedPosts[0];
                                const mostShares = mostSharedPost.shareCount || 0;
                                console.log('Most shared post:', mostSharedPost.title, 'with', mostShares, 'shares');
                                
                                document.getElementById('analytics-most-shared').textContent = 
                                    `${mostSharedPost.title} (${mostShares})`;
                            } else {
                                document.getElementById('analytics-most-shared').textContent = 'None';
                            }
                        } catch (parseError) {
                            console.error('Error parsing most shared post JSON:', parseError);
                            document.getElementById('analytics-most-shared').textContent = 'None';
                        }
                    } else {
                        console.error(`Error fetching most shared post: ${mostSharedResponse.status}`);
                        document.getElementById('analytics-most-shared').textContent = 'None';
                    }
                } catch (error) {
                    console.error('Error in most shared post analytics:', error);
                    document.getElementById('analytics-most-shared').textContent = 'None';
                }
                
                // Active users
                const usersResponse = await fetch('/api/admin/users', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const users = await usersResponse.json();
                
                const activeUsers = users.filter(user => user.status === 'active').length;
                document.getElementById('analytics-active-users').textContent = activeUsers;
                
                // You could add chart visualization here if you want to use a charting library
                // For example, using Chart.js or similar
                
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        async function editBlog(blogId) {
            try {
                console.log('Editing blog with ID:', blogId);
                
                // Validate blog ID before making the request
                if (!blogId || typeof blogId !== 'string' || blogId.trim() === '') {
                    throw new Error('Invalid blog ID');
                }
                
                const response = await fetch(`/api/admin/posts/${blogId}`, {
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Server error response:', errorText);
                    throw new Error(`Server responded with status: ${response.status}`);
                }
                
                // Get the response text first
                const responseText = await response.text();
                console.log('Raw response from edit endpoint:', responseText);
                
                // Try to parse as JSON regardless of content type
                let blog;
                try {
                    blog = JSON.parse(responseText);
                    console.log('Successfully parsed blog data:', blog);
                } catch (parseError) {
                    console.error('Error parsing response as JSON:', parseError);
                    console.error('Response body (first 100 chars):', responseText.substring(0, 100));
                    throw new Error(`Failed to parse response as JSON: ${parseError.message}`);
                }
                console.log('Blog data for editing:', blog);
                
                if (!blog || !blog._id) {
                    throw new Error('Invalid blog data received');
                }
                
                // Populate the edit form
                document.getElementById('editBlogId').value = blog._id;
                document.getElementById('editTitle').value = blog.title || '';
                document.getElementById('editCategory').value = blog.category || 'Uncategorized';
                document.getElementById('editContent').value = blog.content || '';
                document.getElementById('editStatus').value = blog.status || 'published';
                
                // Show the modal
                document.getElementById('editModal').style.display = 'block';
            } catch (error) {
                console.error('Error loading blog for edit:', error);
                alert(`Error loading blog for edit: ${error.message}`);
            }
        }

        async function saveEditedBlog() {
            try {
                const blogId = document.getElementById('editBlogId').value;
                if (!blogId) {
                    throw new Error('Missing blog ID');
                }
                
                // Validate form fields
                const title = document.getElementById('editTitle').value.trim();
                const category = document.getElementById('editCategory').value.trim();
                const content = document.getElementById('editContent').value.trim();
                
                if (!title) {
                    throw new Error('Title is required');
                }
                
                if (!category) {
                    throw new Error('Category is required');
                }
                
                if (!content) {
                    throw new Error('Content is required');
                }
                
                const updatedBlog = {
                    title,
                    category,
                    content,
                    status: document.getElementById('editStatus').value
                };

                console.log('Saving edited blog:', updatedBlog);
                
                const response = await fetch(`/api/admin/posts/${blogId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(updatedBlog)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Server error response:', errorText);
                    throw new Error(`Server responded with status: ${response.status}`);
                }
                
                // Success - close modal and reload posts
                document.getElementById('editModal').style.display = 'none';
                alert('Blog post updated successfully');
                loadPosts();
            } catch (error) {
                console.error('Error updating blog:', error);
                alert(`Error updating blog: ${error.message}`);
            }
        }

        async function deleteBlog(blogId) {
            if (!confirm('Are you sure you want to delete this blog post?')) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/posts/${blogId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    loadPosts();
                } else {
                    throw new Error('Failed to delete blog');
                }
            } catch (error) {
                console.error('Error deleting blog:', error);
                alert('Error deleting blog');
            }
        }

        async function approveComment(commentId) {
            try {
                const response = await fetch(`/api/admin/comments/${commentId}/approve`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    loadComments();
                } else {
                    throw new Error('Failed to approve comment');
                }
            } catch (error) {
                console.error('Error approving comment:', error);
                alert('Error approving comment');
            }
        }

        async function deleteComment(commentId) {
            if (!confirm('Are you sure you want to delete this comment?')) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/comments/${commentId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    loadComments();
                } else {
                    throw new Error('Failed to delete comment');
                }
            } catch (error) {
                console.error('Error deleting comment:', error);
                alert('Error deleting comment');
            }
        }

        async function deleteLike(likeId) {
            if (confirm('Are you sure you want to delete this like?')) {
                try {
                    const response = await fetch(`/api/admin/likes/${likeId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (response.ok) {
                        alert('Like deleted successfully');
                        loadLikes();
                    } else {
                        alert('Failed to delete like');
                    }
                } catch (error) {
                    console.error('Error deleting like:', error);
                    alert('Error deleting like');
                }
            }
        }

        function viewPost(postId) {
            // Open the post in a new tab
            window.open(`/post.html?id=${postId}`, '_blank');
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            localStorage.removeItem('isAdmin');
            window.location.href = '/login.html';
        }

        // User Management Functions
        async function loadUsers() {
            try {
                const response = await fetch('/api/admin/users', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const users = await response.json();
                
                const tableBody = document.getElementById('users-table-body');
                if (users.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="7" style="text-align: center;">No users found</td></tr>`;
                    return;
                }
                
                tableBody.innerHTML = users.map(user => {
                    const subscriptionStatus = user.subscription?.status === 'active' ? 
                        `<span class="status-badge">Active</span>` : 
                        `<span class="status-badge pending">Inactive</span>`;
                    
                    const userStatus = user.status === 'active' ? 
                        `<span class="status-badge">Active</span>` : 
                        `<span class="status-badge pending">${user.status}</span>`;
                    
                    return `
                    <tr>
                        <td>${user.username}</td>
                        <td>${user.email}</td>
                        <td>${user.fullname || '-'}</td>
                        <td>${userStatus}</td>
                        <td>${subscriptionStatus}</td>
                        <td>${new Date(user.createdAt).toLocaleDateString()}</td>
                        <td>
                            <button class="action-btn edit-btn" onclick="viewUserDetails('${user._id}')">
                                <i class="fas fa-user-edit"></i>
                            </button>
                            ${user.status === 'active' ? 
                                `<button class="action-btn delete-btn" onclick="deactivateUser('${user._id}')">
                                    <i class="fas fa-user-slash"></i>
                                </button>` : 
                                `<button class="action-btn edit-btn" onclick="activateUser('${user._id}')">
                                    <i class="fas fa-user-check"></i>
                                </button>`
                            }
                        </td>
                    </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('users-table-body').innerHTML = 
                    `<tr><td colspan="7" style="text-align: center;">Error loading users: ${error.message}</td></tr>`;
            }
        }
        
        let currentUserId = null;
        
        async function viewUserDetails(userId) {
            try {
                currentUserId = userId;
                
                // Fetch user details
                const response = await fetch(`/api/admin/users/${userId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    throw new Error(`Server responded with status: ${response.status}`);
                }
                
                const user = await response.json();
                
                // Populate user details in the modal
                document.getElementById('userDetailUsername').textContent = user.username;
                document.getElementById('userDetailEmail').textContent = user.email;
                document.getElementById('userDetailFullname').textContent = user.fullname || '-';
                document.getElementById('userDetailBio').textContent = user.bio || '-';
                document.getElementById('userDetailStatus').value = user.status;
                
                const subscriptionInfo = user.subscription?.status === 'active' ?
                    `Active (${user.subscription.plan}, expires: ${new Date(user.subscription.expiresAt).toLocaleDateString()})` :
                    'Inactive';
                document.getElementById('userDetailSubscription').textContent = subscriptionInfo;
                document.getElementById('userDetailRegistration').textContent = new Date(user.createdAt).toLocaleString();
                
                // Load user's posts
                await loadUserPosts(userId);
                
                // Load user's comments
                await loadUserComments(userId);
                
                // Show the modal
                document.getElementById('userDetailModal').style.display = 'block';
                showUserActivityTab('posts');
            } catch (error) {
                console.error('Error fetching user details:', error);
                alert(`Error fetching user details: ${error.message}`);
            }
        }
        
        async function loadUserPosts(userId) {
            try {
                const response = await fetch(`/api/admin/users/${userId}/posts`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    throw new Error(`Server responded with status: ${response.status}`);
                }
                
                const posts = await response.json();
                const tableBody = document.getElementById('userPostsTableBody');
                
                if (posts.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="5" style="text-align: center;">No posts found</td></tr>`;
                    return;
                }
                
                tableBody.innerHTML = posts.map(post => {
                    const statusBadge = post.status === 'published' ?
                        `<span class="status-badge">Published</span>` :
                        `<span class="status-badge pending">${post.status}</span>`;
                    
                    return `
                    <tr>
                        <td>${post.title}</td>
                        <td>${post.category || 'Uncategorized'}</td>
                        <td>${new Date(post.createdAt).toLocaleDateString()}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="action-btn edit-btn" onclick="viewPost('${post._id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading user posts:', error);
                document.getElementById('userPostsTableBody').innerHTML = 
                    `<tr><td colspan="5" style="text-align: center;">Error loading posts: ${error.message}</td></tr>`;
            }
        }
        
        async function loadUserComments(userId) {
            try {
                const response = await fetch(`/api/admin/users/${userId}/comments`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    throw new Error(`Server responded with status: ${response.status}`);
                }
                
                const comments = await response.json();
                const tableBody = document.getElementById('userCommentsTableBody');
                
                if (comments.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="5" style="text-align: center;">No comments found</td></tr>`;
                    return;
                }
                
                tableBody.innerHTML = comments.map(comment => {
                    const statusBadge = comment.status === 'Approved' ?
                        `<span class="status-badge">Approved</span>` :
                        `<span class="status-badge pending">${comment.status || 'Pending'}</span>`;
                    
                    return `
                    <tr>
                        <td>${comment.postTitle || 'Unknown Post'}</td>
                        <td>${comment.content}</td>
                        <td>${new Date(comment.createdAt).toLocaleDateString()}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="action-btn delete-btn" onclick="deleteComment('${comment._id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading user comments:', error);
                document.getElementById('userCommentsTableBody').innerHTML = 
                    `<tr><td colspan="5" style="text-align: center;">Error loading comments: ${error.message}</td></tr>`;
            }
        }
        
        function showUserActivityTab(tab) {
            // Update tab styling
            document.querySelectorAll('.user-activity-tab').forEach(t => t.style.display = 'none');
            document.getElementById(`user${tab.charAt(0).toUpperCase() + tab.slice(1)}Tab`).style.display = 'block';
            
            // Update active tab button
            document.querySelectorAll('#userDetailContent .tabs .tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`#userDetailContent .tabs .tab[onclick="showUserActivityTab('${tab}')"]`).classList.add('active');
        }
        
        function closeUserModal() {
            document.getElementById('userDetailModal').style.display = 'none';
            currentUserId = null;
        }
        
        async function saveUserDetails() {
            if (!currentUserId) return;
            
            try {
                const status = document.getElementById('userDetailStatus').value;
                
                const response = await fetch(`/api/admin/users/${currentUserId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ status })
                });
                
                if (!response.ok) {
                    throw new Error(`Server responded with status: ${response.status}`);
                }
                
                alert('User details updated successfully');
                closeUserModal();
                loadUsers();
            } catch (error) {
                console.error('Error updating user:', error);
                alert(`Error updating user: ${error.message}`);
            }
        }
        
        async function activateUser(userId) {
            try {
                const response = await fetch(`/api/admin/users/${userId}/activate`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    throw new Error(`Server responded with status: ${response.status}`);
                }
                
                alert('User activated successfully');
                loadUsers();
            } catch (error) {
                console.error('Error activating user:', error);
                alert(`Error activating user: ${error.message}`);
            }
        }
        
        async function deactivateUser(userId) {
            if (!confirm('Are you sure you want to deactivate this user?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/users/${userId}/deactivate`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    throw new Error(`Server responded with status: ${response.status}`);
                }
                
                alert('User deactivated successfully');
                loadUsers();
            } catch (error) {
                console.error('Error deactivating user:', error);
                alert(`Error deactivating user: ${error.message}`);
            }
        }
    </script>
</body>
</html>